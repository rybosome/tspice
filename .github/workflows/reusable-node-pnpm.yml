name: Reusable Node + pnpm

on:
  workflow_call:
    inputs:
      runs_on:
        description: Runner label (e.g. ubuntu-latest, macos-latest)
        required: true
        type: string
      node_version:
        description: Node.js version (e.g. from a matrix)
        required: true
        type: string
      pre_install:
        description: Optional shell commands to run before `pnpm install`.
        required: false
        type: string
        default: ''
      command:
        description: Commands to run after `pnpm install` (multiline supported)
        required: true
        type: string
      enable_cspice_cache:
        description: Enable the CSPICE cache used by `pnpm run check:native`.
        required: false
        type: boolean
        default: false

jobs:
  run:
    runs-on: ${{ inputs.runs_on }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm + Node
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ inputs.node_version }}

      # Node 22 + node-gyp can be flaky when it tries to download headers from nodejs.org.
      # Point node-gyp at the headers shipped with the installed Node runtime instead.
      - name: Use local Node headers for node-gyp
        shell: bash
        run: |
          NODE_ROOT=$(node -p 'require("path").dirname(require("path").dirname(process.execPath))')
          echo "npm_config_nodedir=$NODE_ROOT" >> "$GITHUB_ENV"

      - name: Pre-install
        if: ${{ inputs.pre_install != '' }}
        run: ${{ inputs.pre_install }}

      - name: Cache CSPICE
        # .cache/cspice is populated by `pnpm run fetch:cspice` (invoked via `pnpm run check:native`).
        # The `.cache/cspice` path is defined in scripts/fetch-cspice.mjs.
        # Cache is keyed by OS/arch + manifest hash so it can be reused across Node versions.
        # `fetch:cspice` output is controlled by `scripts/cspice.manifest.json`.
        # Cache key intentionally does not include Node version (cache contains CSPICE archives only).
        # Cache key includes an explicit schema version (`v1`) we control; bump it if the on-disk cache layout changes.
        if: ${{ inputs.enable_cspice_cache }}
        uses: actions/cache@v4
        with:
          path: .cache/cspice
          key: cspice-v1-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('scripts/cspice.manifest.json') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run command
        run: ${{ inputs.command }}

      - name: Upload Playwright artifacts (if present)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts-${{ inputs.runs_on }}-node${{ inputs.node_version }}
          path: |
            apps/orrery/playwright-report
            apps/orrery/test-results
          if-no-files-found: ignore
