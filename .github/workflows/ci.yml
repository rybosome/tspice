name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  check:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        node: ['20', '22']

    uses: ./.github/workflows/reusable-node-pnpm.yml
    with:
      runs_on: ${{ matrix.os }}
      node_version: ${{ matrix.node }}
      command: pnpm run check

  viewer-e2e:
    name: Viewer Playwright e2e (ubuntu + node 22)
    uses: ./.github/workflows/reusable-node-pnpm.yml
    with:
      runs_on: ubuntu-latest
      node_version: '22'
      command: |
        pnpm -C apps/tspice-viewer exec playwright install --with-deps chromium
        pnpm -C apps/tspice-viewer e2e

  verify-dist-publish:
    name: Verify dist-publish tarball (ubuntu + node 22)
    uses: ./.github/workflows/reusable-node-pnpm.yml
    with:
      runs_on: ubuntu-latest
      node_version: '22'
      command: |
        set -euo pipefail

        ./packages/tspice/scripts/ci-build-dist-publish-deps.sh

        pnpm -C packages/tspice run build:dist-publish
        pnpm -C packages/tspice run verify:dist-publish

  check-native:
    # Runs in parallel with `check` to surface native-only failures quickly.
    # Assumes GitHub-hosted runners (Ubuntu with apt-get, macOS with Homebrew).
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        node: ['20', '22']

    uses: ./.github/workflows/reusable-node-pnpm.yml
    with:
      runs_on: ${{ matrix.os }}
      node_version: ${{ matrix.node }}
      pre_install: |
        set -euo pipefail

        if [ "$RUNNER_OS" = "Linux" ]; then
          if command -v uncompress >/dev/null; then
            exit 0
          fi

          # Assumes ubuntu-latest; update if the Linux distribution changes.
          if ! command -v apt-get >/dev/null; then
            echo "This step assumes an Ubuntu/Debian-based Linux runner with apt-get available. Update the workflow before using a different Linux image." >&2
            exit 1
          fi

          sudo apt-get update

          if ! sudo apt-get install -y --no-install-recommends ncompress; then
            echo "Failed to install 'ncompress'. Verify that it is available on ubuntu-latest or adjust the workflow to use an alternative package/source." >&2
            exit 1
          fi

          if ! command -v uncompress >/dev/null; then
            echo "'uncompress' still not found after installing ncompress." >&2
            exit 1
          fi
        elif [ "$RUNNER_OS" = "macOS" ]; then
          # Assumes Homebrew is available on the macOS runner.
          if command -v uncompress >/dev/null 2>&1; then
            exit 0
          fi

          if ! command -v brew >/dev/null 2>&1; then
            echo "uncompress not found and Homebrew (brew) is missing; cannot install ncompress on the macOS CI runner." >&2
            exit 1
          fi

          if ! brew update; then
            echo "Homebrew update failed; cannot install ncompress to provide uncompress." >&2
            exit 1
          fi

          if ! brew install ncompress; then
            echo "Homebrew failed to install ncompress; cannot provide uncompress." >&2
            exit 1
          fi

          if ! command -v uncompress >/dev/null 2>&1; then
            echo "Installed ncompress but uncompress is still missing from PATH." >&2
            exit 1
          fi
        fi
      enable_cspice_cache: true
      command: |
        set -euo pipefail

        pnpm run check:native

        # Smoke-test packaging for the platform-native optionalDependency that
        # was just staged/built on this runner.
        TARGET_PKG=$(node -e 'const TARGETS={darwin:{arm64:"tspice-native-darwin-arm64",x64:"tspice-native-darwin-x64"},linux:{x64:"tspice-native-linux-x64-gnu"}};process.stdout.write(TARGETS[process.platform]?.[process.arch] ?? "");')
        if [ -z "$TARGET_PKG" ]; then
          echo "[native-pack-smoke] No supported platform package for runner; skipping."
          exit 0
        fi

        PKG_DIR="packages/$TARGET_PKG"
        if [ ! -f "$PKG_DIR/tspice_backend_node.node" ]; then
          echo "[native-pack-smoke] Missing staged native addon at $PKG_DIR/tspice_backend_node.node" >&2
          exit 1
        fi

        TARBALL=$(cd "$PKG_DIR" && npm pack --silent)
        tar -tf "$PKG_DIR/$TARBALL" | grep -q '^package/tspice_backend_node\.node$'
        rm -f "$PKG_DIR/$TARBALL"
