name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  check:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        node: ['20', '22']

    uses: ./.github/workflows/reusable-node-pnpm.yml
    with:
      runs_on: ${{ matrix.os }}
      node_version: ${{ matrix.node }}
      command: pnpm run check

  check-llm-artifacts:
    name: check:llm-artifacts (ubuntu + node 22)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm + Node
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: '22'

      - name: Install dependencies (docs only)
        run: pnpm install --frozen-lockfile --filter @rybosome/docs

      - name: Generate LLM artifacts
        run: pnpm generate:llm

      - name: Ensure artifacts are up to date
        run: git diff --exit-code

  orrery-e2e:
    name: Orrery Playwright e2e (ubuntu + node 22)
    uses: ./.github/workflows/reusable-node-pnpm.yml
    with:
      runs_on: ubuntu-latest
      node_version: '22'
      command: |
        pnpm -C apps/orrery exec playwright install --with-deps chromium
        pnpm -C apps/orrery e2e

  verify-dist-publish:
    name: Verify dist-publish tarball (ubuntu + node 22)
    uses: ./.github/workflows/reusable-node-pnpm.yml
    with:
      runs_on: ubuntu-latest
      node_version: '22'
      command: |
        set -euo pipefail

        ./packages/tspice/scripts/ci-build-dist-publish-deps.sh

        pnpm -C packages/tspice run build:dist-publish
        pnpm -C packages/tspice run verify:dist-publish

  test-verify:
    name: Parity verifier (ubuntu + node 22)
    uses: ./.github/workflows/reusable-node-pnpm.yml
    with:
      runs_on: ubuntu-latest
      node_version: '22'
      pre_install: |
        set -euo pipefail

        ./scripts/ci/ensure-uncompress.sh
      enable_cspice_cache: true
      command: |
        set -euo pipefail

        pnpm run fetch:cspice

        export TSPICE_BACKEND_VERIFY_BACKEND=wasm
        pnpm test:verify

  check-native:
    # Runs in parallel with `check` to surface native-only failures quickly.
    # Assumes GitHub-hosted runners (Ubuntu with apt-get, macOS with Homebrew).
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        node: ['20', '22']

    uses: ./.github/workflows/reusable-node-pnpm.yml
    with:
      runs_on: ${{ matrix.os }}
      node_version: ${{ matrix.node }}
      pre_install: |
        set -euo pipefail

        ./scripts/ci/ensure-uncompress.sh
      enable_cspice_cache: true
      command: |
        set -euo pipefail

        export TSPICE_EXPECT_NATIVE=true

        pnpm run check:native

        # Smoke-test packaging for the platform-native optionalDependency that
        # was just staged/built on this runner.
        TARGET_PKG=$(node -e 'const TARGETS={darwin:{arm64:"tspice-native-darwin-arm64",x64:"tspice-native-darwin-x64"},linux:{x64:"tspice-native-linux-x64-gnu"}};process.stdout.write(TARGETS[process.platform]?.[process.arch] ?? "");')
        if [ -z "$TARGET_PKG" ]; then
          echo "[native-pack-smoke] No supported platform package for runner; skipping."
          exit 0
        fi

        # `pnpm run check:native` stages the native addon early in the script,
        # but later build/test steps may clean the workspace. Re-stage the
        # platform-specific native addon right before packing so we verify the
        # tarball includes `tspice_backend_node.node`.
        pnpm run stage:native-platform

        PKG_DIR="packages/$TARGET_PKG"
        TARGET_PKG_NAME=$(node -p "require('./$PKG_DIR/package.json').name")
        if [ ! -f "$PKG_DIR/tspice_backend_node.node" ]; then
          echo "[native-pack-smoke] Missing staged native addon at $PKG_DIR/tspice_backend_node.node" >&2
          exit 1
        fi

        TARBALL=$(cd "$PKG_DIR" && npm pack --silent)

        # Install the packed tarball into a clean project and ensure it can be
        # required at runtime (catches packaging + install/runtime issues, not
        # just missing files).
        TARBALL_PATH="$GITHUB_WORKSPACE/$PKG_DIR/$TARBALL"
        TMP_DIR=$(mktemp -d)
        cleanup() {
          rm -rf "$TMP_DIR"
          rm -f "$TARBALL_PATH"
        }
        trap cleanup EXIT

        cd "$TMP_DIR"
        npm init -y >/dev/null
        npm install --no-audit --no-fund --loglevel=error "$TARBALL_PATH" >/dev/null
        TARGET_PKG_NAME="$TARGET_PKG_NAME" node <<'NODE'
        const pkgName = process.env.TARGET_PKG_NAME;
        if (!pkgName) {
          throw new Error("[native-pack-smoke] Missing TARGET_PKG_NAME env var");
        }

        const { bindingPath } = require(pkgName);
        if (typeof bindingPath !== "string" || bindingPath.length === 0) {
          throw new Error(`[native-pack-smoke] ${pkgName} did not export a non-empty bindingPath`);
        }

        const addon = require(bindingPath);
        if (!addon || typeof addon.spiceVersion !== "function") {
          throw new Error(`[native-pack-smoke] Native addon loaded from ${bindingPath} is missing spiceVersion()`);
        }

        const version = addon.spiceVersion();
        if (typeof version !== "string" || version.trim().length === 0) {
          throw new Error(`[native-pack-smoke] Expected addon.spiceVersion() to return a non-empty string, got: ${String(version)}`);
        }

        console.log(`[native-pack-smoke] CSPICE toolkit version: ${version}`);
        NODE

  smoke-native-optional-deps:
    name: "Smoke: packed @rybosome/tspice + native optionalDependency (${{ matrix.os }})"
    # Mirrors the release workflow's pre-publish smoke test, but runs on PRs.
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14, macos-15-intel]

    uses: ./.github/workflows/reusable-node-pnpm.yml
    with:
      runs_on: ${{ matrix.os }}
      node_version: '22'
      pre_install: |
        set -euo pipefail

        ./scripts/ci/ensure-uncompress.sh
      enable_cspice_cache: true
      command: |
        set -euo pipefail

        # Build dist-publish tarball for @rybosome/tspice
        ./packages/tspice/scripts/ci-build-dist-publish-deps.sh
        pnpm -C packages/tspice run build:dist-publish

        # Build + stage the native addon for this runner's platform package.
        pnpm run fetch:cspice
        pnpm -C packages/backend-node run build:native
        pnpm run stage:native-platform

        TARGET_PKG=$(node -e 'const TARGETS={darwin:{arm64:"tspice-native-darwin-arm64",x64:"tspice-native-darwin-x64"},linux:{x64:"tspice-native-linux-x64-gnu"}};process.stdout.write(TARGETS[process.platform]?.[process.arch] ?? "");')
        if [ -z "$TARGET_PKG" ]; then
          echo "[tspice-native-smoke] No supported platform package for runner; skipping."
          exit 0
        fi

        PKG_DIR="packages/$TARGET_PKG"
        if [ ! -f "$PKG_DIR/tspice_backend_node.node" ]; then
          echo "[tspice-native-smoke] Missing staged native addon at $PKG_DIR/tspice_backend_node.node" >&2
          exit 1
        fi

        # Pack the to-be-installed tarballs.
        cd packages/tspice/dist-publish
        TSPICE_TARBALL=$(npm pack --silent)
        TSPICE_TARBALL_PATH="${PWD}/${TSPICE_TARBALL}"

        cd "${GITHUB_WORKSPACE}/$PKG_DIR"
        NATIVE_TARBALL=$(npm pack --silent)
        NATIVE_TARBALL_PATH="${PWD}/${NATIVE_TARBALL}"

        TMP_DIR=$(mktemp -d)
        cleanup() {
          rm -rf "$TMP_DIR"
          rm -f "$TSPICE_TARBALL_PATH" "$NATIVE_TARBALL_PATH"
        }
        trap cleanup EXIT
        echo "[tspice-native-smoke] Using temp project: ${TMP_DIR}"
        cd "${TMP_DIR}"

        npm init -y >/dev/null

        # Ensure ESM by default in the temp project.
        node -e 'const fs=require("node:fs"); const p="package.json"; const j=JSON.parse(fs.readFileSync(p,"utf8")); j.type="module"; fs.writeFileSync(p, JSON.stringify(j,null,2)+"\n");'

        npm install --include=optional --no-audit --no-fund --loglevel=error "${TSPICE_TARBALL_PATH}" "${NATIVE_TARBALL_PATH}"

        node "${GITHUB_WORKSPACE}/scripts/smoke-tspice-native.mjs"
